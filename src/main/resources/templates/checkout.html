<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Thanh Toán</title>
	<link rel="icon" href="https://gigamall.com.vn/data/2024/05/10/14290213_shushiwa.jpg" type="image/x-icon">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
	<!-- AOS CSS -->
	<link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">

	<link href="index.css" rel="stylesheet">
	<link href="menu.css" rel="stylesheet">
	<!-- Thêm Font Awesome CDN -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
		.star-rating {
				  display: inline-flex;
				  font-size: 50px; /* Kích thước của ngôi sao */
				  color: #ccc; /* Màu mặc định (xám) */
				}

				.star-rating .star {
				  cursor: default;
				}

				.star-rating .star.filled {
				  color: gold; /* Màu vàng cho sao được tô */
				}

				.product-detail {
				    max-width: 1000px;
				    margin: auto;
					margin-top: 100px;
				    display: flex;
				    align-items: flex-start;
				    gap: 20px;
				}

				.product-detail img {
				    width: 40%; /* Chiếm 40% chiều rộng */
				    border-radius: 8px;
				}

				.product-info {
				    width: 60%; /* Chiếm 60% chiều rộng */
				}

				.product-info h1 {
				    font-size: 2rem;
				    margin-bottom: 15px;
				}

				.product-info p {
				    font-size: 1rem;
				    margin-bottom: 8px;
				}


		        .suggested-items {
		            margin: 40px;
		        }

		        .suggested-items h3 {
		            font-size: 1.8rem;
		            margin-bottom: 20px;
		        }

		        .suggested-items .item-card {
		            margin-bottom: 20px;
		        }

		        .suggested-items .card-body {
		            text-align: center;
		        }
				.price {
				    color: #ff7f50;
				    font-weight: bold;
				}
				#toastNotification {
			      animation: slide-in 0.5s ease, fade-out 0.5s 4.5s ease;
			  }
			  .modal-content2 {
			  padding: 50px	;
			      max-width: 100%;
			      max-height: 100%;
			      object-fit: contain; /* Đảm bảo hình ảnh không méo */
			      transition: transform 0.3s ease-in-out;
			      background-color: #fdf5f3;
			      padding: 10px; /* Thêm khoảng trống để hình ảnh không bị sát viền */
				  margin: 0 auto;
				  box-sizing: border-box;
			  }


				  /* Cố định controls ở dưới cùng */
				  .controls {
				      position: fixed;
				      bottom: 20px;  /* Cách mép dưới trang web 20px */
				      left: 50%;
				      transform: translateX(-50%);
				      display: flex;
				      gap: 10px;
				  }

				  .controls button {
				      font-size: 20px;
				      padding: 10px 15px;
				      cursor: pointer;
				      background: white;
				      border: none;
				      border-radius: 5px;
				  }

				  /* Nút đóng */
				  .close {
				      position: fixed;
				      top: 15px;
				      right: 25px;
				      color: white;
				      font-size: 30px;
				      cursor: pointer;
				      background: rgba(0, 0, 0, 0.5);
				      padding: 5px 15px;
				      border-radius: 5px;
				      z-index: 10000; /* Đảm bảo luôn nằm trên tất cả các phần khác */
				  }


				  @keyframes slide-in {
				      from {
				          transform: translateX(100%);
				          opacity: 0;
				      }
				      to {
				          transform: translateX(0);
				          opacity: 1;
				      }
				  }

				  @keyframes fade-out {
				      from {
				          opacity: 1;
				      }
				      to {
				          opacity: 0;
				      }
				  }
		#voucherCode::placeholder {
		    font-size: 12px; /* Điều chỉnh kích thước theo mong muốn */
		    color: #999; /* (Tuỳ chọn) Thay đổi màu chữ nếu cần */
		}

		.voucher-card {
		    background: #f8f9fa;
		    border-left: 5px solid #007bff;
		    transition: 0.3s;
		}

		.voucher-card:hover {
		    transform: translateY(-3px);
		    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
		}

		.btn-success {
		    background-color: #28a745 !important;
		}
		.modal-dialog {
		    display: flex;
		    justify-content: center;
		    align-items: center;
		    min-height: 80vh;
		}

		.spinner-pulse {
		      border: 4px solid #f3f3f3;
		      border-top: 4px solid #3498db;
		      border-radius: 50%;
		      width: 50px;
		      height: 50px;
		      animation: spin 2s linear infinite, pulse 1.5s ease-in-out infinite;
		  }

		  @keyframes spin {
		      0% { transform: rotate(0deg); }
		      100% { transform: rotate(360deg); }
		  }

		  @keyframes pulse {
		      0% { transform: scale(1); opacity: 1; }
		      50% { transform: scale(1.2); opacity: 0.6; }
		      100% { transform: scale(1); opacity: 1; }
		  }
		.dashed-border-right {
		    border-right: 2px dashed #ddd;

		}
		.dashed-border-left {
				    border-left: 2px dashed #ddd;

				}

       
        h1 {
            font-weight: bold;
            font-size: 2rem;
            text-align: center;
            margin-bottom: 30px;
        }
        .table thead th {
            font-weight: bold;
            text-transform: uppercase;
            font-size: 1rem;
            border-bottom: 2px solid #ddd;
        }
        .table tbody td {
            vertical-align: middle;
        }
        .cart-summary {
            border: 1px solid #ddd;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
			height: max-content;
        }
        .cart-summary h5 {
            font-weight: bold;
        }
        .cart-summary .total-amount {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .btn-primary {
            background-color: #ff6f61;
            border-color: #ff6f61;
        }
        .btn-primary:hover {
            background-color: #ff4f41;
            border-color: #ff4f41;
        }
		.scrollable-div {
		    max-height: 530px; /* Đặt chiều cao tối đa theo nhu cầu */
		    overflow-y: auto; /* Thêm thanh cuộn dọc nếu nội dung vượt quá chiều cao */
		   
		}
		.voucher-card-container {
		    display: flex;
		    justify-content: center;
		    margin-top: 15px;
		}

		.voucher-card {
		    display: flex;
		    align-items: center;
		    width: 100%;
		    max-width: 500px;
		    background: #f8f9fa;
		    border-radius: 10px;
		    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
		    overflow: hidden;
		}

		.voucher-image img {
		    width: 100px;
		    height: 140px;
		    object-fit: cover;
		    border-radius: 10px 0 0 10px;
		}

		.voucher-details {
		    flex-grow: 1;
		    padding: 10px;
		}

		.voucher-title {
		    font-size: 16px;
		    font-weight: bold;
		    margin-bottom: 5px;
		}

		.voucher-discount {
		    font-size: 15px;
		    font-weight: bold;
		    color: #28a745;
		}

		.voucher-expiry {
		    font-size: 13px;
		    color: #666;
		}

		.voucher-actions {
		    justify-content: flex-end;  /* Đẩy nội dung về bên phải */
		    align-items: center;  /* Căn giữa theo chiều dọc */
		    gap: 10px;  /* Khoảng cách giữa nút "Hủy" và "Điều kiện" */
		    padding: 10px;
		}

		.voucher-actions button {
		    padding: 5px 12px;
		    font-size: 13px;
		    font-weight: bold;
		}
		
		.voucher-actions a {
		    text-decoration: none;
		    font-size: 13px;
		    font-weight: bold;
		    color: #007bff; /* Màu xanh đặc trưng */
		    white-space: nowrap; /* Giữ chữ trên cùng một dòng */
		    display: inline-block; /* Đảm bảo không bị xuống dòng */
		    margin-top: auto; /* Đẩy xuống dưới cùng */
		}
		.modal-overlay {
		    position: fixed;
		    top: 0;
		    left: 0;
		    width: 100%;
		    height: 100%;
		    z-index: 1049; /* Đặt dưới modal-content nhưng trên backdrop của Bootstrap */
		}
		/* Đảm bảo modal vẫn bấm được */
		.modal-dialog {
		    position: relative;
		    z-index: 1051;
		}
		.line-loading {
		  width: 100%;
		  height: 4px;
		  position: relative;
		  overflow: hidden;
		  margin-top: 10px;
		  border-radius: 2px;
		}

		.line-loading::after {
		  content: "";
		  position: absolute;
		  width: 50%; /* Độ dài hiệu ứng chạy */
		  height: 100%;
		  background-color: #FFC107; /* Màu xanh thành công */
		  animation: lineLoad 2s linear infinite;
		}

		@keyframes lineLoad {
		  0% {
		    left: -50%;
		  }
		  100% {
		    left: 100%;
		  }
		}

    </style>
</head>
<body>
	<!-- Navbar trên màn hình lớn -->
	<th:block th:replace="fragments/header :: header"></th:block>
	<script src="/js/chatbot.js"></script>
 
	<div class="container mt-5">
	    <h1>Trang Thanh Toán</h1>
		<div class="cart-summary">
	    <div class="row">
	        <div class="col-md-4 dashed-border-right scrollable-div">
				<div class="align-items-center">
				    <label for="orderCode" class="form-label me-2">Mã đơn hàng:</label>
				    <span id="orderCode" class="form-label me-2 fw-bold" th:text="${orderCode}">0</span>
				</div>
				<hr>
				<table class="table">
				    <thead>
				        <tr>
				            <th colspan="2">Món ăn</th>
				            <th>Giá</th>
				            <th>SL</th>
				            <th>Tổng</th>
				        </tr>
				    </thead>
				    <tbody>
				        <tr th:each="item : ${cartItems}">
				            <td><img th:src="${item.imageUrl}" alt="Picture" width="50" onclick="openModal(this)"></td>
				            <td th:text="${item.name}"></td>
				            <td th:text="${#numbers.formatInteger(item.price, 0, 'POINT')}"></td>
				            <td th:text="${item.quantity}"></td>
							<td th:text="${#numbers.formatInteger(item.price * item.quantity, 0, 'POINT')}"></td>
				        </tr>
				    </tbody>
				</table>
			</div>
				<div class="col-md-4">
				<div class="payment-summary">
				    <!-- Điểm khả dụng -->
					<h4>Thông Tin Thanh Toán</h4>
					<hr>
					<div class="mb-3 mt-3 d-flex align-items-center">
					    <label for="availablePoints" class="form-label me-2">Số điểm khả dụng:</label>
					    <span id="availablePoints" class="form-label me-2 fw-bold" th:text="${availablePoints}">0</span>
					</div>
					<div class=" justify-content-between mb-3">
						<!-- Dùng điểm -->
						<div class="align-items-center flex-grow-1">
						    <label for="pointsToUse" class="form-label me-2">Dùng điểm:</label>
						    <form th:action="@{/applyPoints}" method="post" class="d-flex flex-grow-1">
						        <input type="number" class="form-control" id="pointsToUse" name="pointsToUse"
						               min="0" th:max="${availablePoints}" th:value="${session.pointsToUse}">
						        <button type="submit" class="btn btn-sm btn-primary ms-2">Áp dụng</button>
						    </form>
						</div>

						<!-- Ô nhập voucher (Bấm vào sẽ mở modal) -->
						<div class="align-items-center flex-grow-1">
						    <label for="voucherCode" class="form-label me-2">Mã voucher:</label>
						    <div class="input-group">
						        <input type="text" class="form-control" id="voucherCode" name="voucherCode"
						               th:value="${session.voucher != null ? session.voucher.code : ''}" readonly
						               placeholder="Nhập mã/ chọn voucher" data-bs-toggle="modal" data-bs-target="#voucherModal">
						        <span class="input-group-text bg-primary text-white" data-bs-toggle="modal" data-bs-target="#voucherModal" style="cursor: pointer;">
						            <i class="fas fa-ticket-alt"></i>
						        </span>
						    </div>
						</div>
						<!-- Phiếu mua hàng -->
						<div class="voucher-card-container" th:if="${session.voucher != null}">
						    <div class="voucher-card">
						        <!-- Hình ảnh thương hiệu -->
						        <div class="voucher-image">
						            <img src="https://gigamall.com.vn/data/2024/05/10/14290213_shushiwa.jpg" alt="Voucher Sushi Wa">
						        </div>

						        <!-- Chi tiết voucher -->
						        <div class="voucher-details">
						            <h5 class="voucher-title">
						                <i class="fas fa-ticket-alt text-primary"></i>
						                <span th:text="${session.voucher.code}"></span>
						            </h5>
						            <p class="voucher-discount">
						                <span th:if="${session.voucher.discountType == 'AMOUNT'}">
						                    Giảm <strong th:text="${#numbers.formatInteger(session.voucher.discountAmount, 0, 'POINT')}"></strong> VND
						                </span>
						                <span th:if="${session.voucher.discountType == 'PERCENT'}">
						                    Giảm <strong th:text="${session.voucher.discountAmount}"></strong>%
						                    (Tối đa <strong th:text="${#numbers.formatInteger(session.voucher.maxDiscount, 0, 'POINT')}"></strong>₫)
						                </span>
						            </p>
						            <p class="voucher-expiry">
						                Đơn tối thiểu: <strong th:text="${#numbers.formatInteger(session.voucher.minOrderAmount, 0, 'POINT')}"></strong>₫<br>
						                HSD: <strong th:text="${#temporals.format(session.voucher.endDate, 'HH:mm dd/MM/yyyy')}"></strong>
						            </p>
						        </div>

								<!-- Nút hủy + Điều kiện -->
								<div class="voucher-actions d-flex flex-column h-100 align-items-end">
								    <!-- Đẩy nút Hủy vào giữa -->
								    <div class="flex-grow-1 d-flex align-items-center">
								        <form th:action="@{/removeVoucher}" method="post">
								            <button type="submit" class="btn btn-outline-danger">Hủy</button>
								        </form>
								    </div>

								    <!-- Nút Điều kiện (hiển thị modal) -->
								    <a href="#" class="mt-auto" data-bs-toggle="modal" data-bs-target="#voucherConditionModal">
								        Điều kiện
								    </a>
								</div>
						    </div>
						</div>

						<!-- Modal hiển thị điều kiện -->
						<div class="modal fade" id="voucherConditionModal" tabindex="-1" aria-labelledby="voucherConditionLabel" aria-hidden="true">
						    <div class="modal-dialog modal-lg">
						        <div class="modal-content">
						            <div class="modal-header">
										<h4>	
							                <i class="fas fa-ticket-alt text-primary"></i>
							                <span th:text="${session.voucher != null ? session.voucher.code : 'Chưa áp dụng voucher'}"></span>
							            </h4>						                
										<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">&times;</button>
						            </div>
						            <div class="modal-body">
						                <pre th:text="${session.voucher != null ? session.voucher.usageCondition : 'Không có thông tin điều kiện'}"></pre>
										<span th:if="${session.voucher != null and session.voucher.applicableToAll}">Áp dụng cho: Tất cả món ăn</span>
										<div th:if="${session.voucher != null and !session.voucher.applicableToAll}" class="border p-3 rounded bg-white">
											<h5>Món ăn áp dụng</h5>
					                          <div class="row">
					                              <div th:each="item : ${session.voucher.applicableItems}"  class="col-md-4 col-sm-6 mb-3">
													<div class="form-check d-flex align-items-center">
									                    <label th:for="'item-' + ${item.itemId}" class="form-check-label flex-grow-1 ml-2 d-flex align-items-center">
									                        <img th:src="${item.imageUrl}" alt="Hình ảnh món ăn" class="rounded" 
									                             style="width: 50px; height: 50px; object-fit: cover; margin-right: 10px;" onclick="openModal(this)">
									                        <div>
									                            <span th:text="${item.name}"></span>
									                            <small class="text-muted d-block">(Giá: <span th:text="${#numbers.formatInteger(item.price, 0, 'POINT')}"></span> VND)</small>
																<form action="/add-to-cart" method="post" onsubmit="localStorage.setItem('scrollPosition', window.scrollY)">
																    <input type="hidden" name="id" th:value="${item.itemId}" />
																    <button type="submit" class="btn btn-xs btn-outline-primary px-2 py-1" style="font-size: 12px; height: 24px; line-height: 1;">
																        <i class="fas fa-cart-plus"></i>
																    </button>
																</form>
									                        </div>
									                    </label>
									                </div>
					                              </div>
					                          </div>
					                      </div>
						            </div>
						        </div>
						    </div>
						</div>
						<!-- Modal điều kiện sử dụng (tạo riêng cho từng voucher) -->
						<div th:each="userVoucher : ${savedVouchers}" th:id="'voucherConditionModal-' + ${userVoucher.voucher.code}" class="modal fade" tabindex="-1" aria-labelledby="voucherConditionLabel" aria-hidden="true">
						    <div class="modal-dialog modal-lg">
						        <div class="modal-content">
						            <div class="modal-header">
						                <h4>
						                    <i class="fas fa-ticket-alt text-primary"></i>
						                    <span th:text="${userVoucher.voucher.code}"></span>
						                </h4>
						                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">&times;</button>
						            </div>
						            <div class="modal-body">
						                <pre th:text="${userVoucher.voucher.usageCondition}"></pre>
						                <span th:if="${userVoucher.voucher.applicableToAll}">Áp dụng cho: Tất cả món ăn</span>
						                <div th:if="${!userVoucher.voucher.applicableToAll}" class="border p-3 rounded bg-white">
						                    <h5>Món ăn áp dụng</h5>
						                    <div class="row">
						                        <div th:each="item : ${userVoucher.voucher.applicableItems}" class="col-md-4 col-sm-6 mb-3">
						                            <div class="form-check d-flex align-items-center">
						                                <label class="form-check-label flex-grow-1 ml-2 d-flex align-items-center">
						                                    <img th:src="${item.imageUrl}" alt="Hình ảnh món ăn" class="rounded" 
						                                         style="width: 50px; height: 50px; object-fit: cover; margin-right: 10px;">
						                                    <div>
						                                        <span th:text="${item.name}"></span>
						                                        <small class="text-muted d-block">(Giá: <span th:text="${#numbers.formatInteger(item.price, 0, 'POINT')}"></span> VND)</small>
						                                        <form action="/add-to-cart" method="post" onsubmit="localStorage.setItem('scrollPosition', window.scrollY)">
						                                            <input type="hidden" name="id" th:value="${item.itemId}" />
						                                            <button type="submit" class="btn btn-xs btn-outline-primary px-2 py-1" style="font-size: 12px; height: 24px; line-height: 1;">
						                                                <i class="fas fa-cart-plus"></i>
						                                            </button>
						                                        </form>
						                                    </div>
						                                </label>
						                            </div>
						                        </div>
						                    </div>
						                </div>
						            </div>
						        </div>
						    </div>  
						</div>
						<!-- Modal chọn voucher -->
						<div class="modal fade" id="voucherModal" tabindex="-1" aria-labelledby="voucherModalLabel" aria-hidden="true">
						    <div class="modal-dialog modal-lg">
						        <div class="modal-content">
						            <div class="modal-header">
						                <!-- Mã voucher -->
						                <div class="align-items-center flex-grow-1">
						                    <form th:action="@{/applyVoucher}" method="post" class="d-flex flex-grow-1">
						                        <input type="text" class="form-control" id="voucherCode" placeholder="Nhập mã voucher" name="voucherCode"
						                               th:value="${session.voucher != null ? session.voucher.code : ''}" required>
						                        <button type="submit" class="btn btn-sm btn-primary ms-2">Áp dụng</button>
						                    </form>
						                </div>
						                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						            </div>

						            <div class="modal-body">
						                <h5 class="modal-title fw-bold" id="voucherModalLabel">
						                    <i class="fas fa-ticket-alt"></i> Chọn Voucher Giảm Giá
						                </h5>

										<!-- Kiểm tra nếu không có voucher hợp lệ -->
										<div th:if="${#lists.isEmpty(savedVouchers)}" class="text-center text-muted">
										    <div>Không có voucher nào khả dụng.</div>
										</div>

										<!-- Danh sách voucher hợp lệ -->
										<div th:if="${not #lists.isEmpty(savedVouchers)}">
										    <div class="voucher-list">
										        <div th:each="userVoucher : ${savedVouchers}" class="voucher-card">
										            <div class="voucher-details">
										                <h5 class="voucher-title">
										                    <i class="fas fa-ticket-alt text-warning"></i>
										                    <span th:text="${userVoucher.voucher.code}"></span>
										                </h5>
										                <p class="voucher-discount">
										                    <span th:if="${userVoucher.voucher.discountType == 'AMOUNT'}">
										                        Giảm <strong th:text="${#numbers.formatInteger(userVoucher.voucher.discountAmount, 0, 'COMMA')}"></strong> VND
										                    </span>
										                    <span th:if="${userVoucher.voucher.discountType == 'PERCENT'}">
										                        Giảm <strong th:text="${userVoucher.voucher.discountAmount}"></strong>%
										                        Tối đa <strong th:text="${userVoucher.voucher.maxDiscount}"></strong>₫
										                    </span>
										                </p>
										                <p class="voucher-expiry">
										                    Đơn hàng tối thiểu: <span th:text="${userVoucher.voucher.minOrderAmount}"></span>₫ <br>
										                    HSD: <span th:text="${userVoucher.voucher.endDate}"></span>
										                </p>
										                <a href="#" class="mt-auto" data-bs-toggle="modal" th:attr="data-bs-target='#voucherConditionModal-' + ${userVoucher.voucher.code}">
										                    Điều kiện
										                </a>
										            </div>

										            <!-- Nút chọn voucher -->
										            <div class="voucher-actions">
										                <form th:action="@{/applyVoucher}" method="post">
										                    <input type="hidden" name="voucherCode" th:value="${userVoucher.voucher.code}">
										                    <button type="submit" class="btn btn-success">Chọn Voucher</button>
										                </form>
										            </div>
										        </div>
										    </div>
										</div>

						                <!-- Nếu đã có voucher được chọn -->
						                <div class="voucher-card-container" th:if="${session.voucher != null}">
						                    <div class="voucher-card">
						                        <div class="voucher-details">
						                            <h5 class="voucher-title">
						                                <i class="fas fa-ticket-alt text-warning"></i>
						                                <span th:text="${session.voucher.code}"></span>
						                            </h5>
						                            <p class="voucher-discount">
						                                <span th:if="${session.voucher.discountType == 'AMOUNT'}">
						                                    Giảm <strong th:text="${#numbers.formatInteger(session.voucher.discountAmount, 0, 'COMMA')}"></strong> VND
						                                </span>
						                                <span th:if="${session.voucher.discountType == 'PERCENT'}">
						                                    Giảm <strong th:text="${session.voucher.discountAmount}"></strong>%
						                                    Tối đa <strong th:text="${session.voucher.maxDiscount}"></strong>₫
						                                </span>
						                            </p>
						                            <p class="voucher-expiry">
						                                Đơn hàng tối thiểu: <span th:text="${session.voucher.minOrderAmount}"></span>₫ <br>
						                                HSD: <span th:text="${session.voucher.endDate}"></span>
						                            </p>
						                        </div>

						                        <!-- Nút hủy voucher -->
						                        <div class="voucher-actions">
						                            <form th:action="@{/removeVoucher}" method="post">
						                                <button type="submit" class="btn btn-danger">Hủy Voucher</button>
						                            </form>
						                        </div>
						                    </div>
						                </div>
						            </div>
						        </div>
						    </div>
						</div>

						<script>
						    document.addEventListener("DOMContentLoaded", function () {
						        document.querySelectorAll(".apply-voucher").forEach(button => {
						            button.addEventListener("click", function () {
						                let selectedVoucher = this.getAttribute("data-code");
						                document.getElementById("voucherCode").value = selectedVoucher;
						                let modal = new bootstrap.Modal(document.getElementById('voucherModal'));
						                modal.hide();
						            });
						        });
						    });
						</script>
					</div>
					<div class="container mt-3">
					    <!-- Hiển thị thông báo lỗi -->
					    <div th:if="${errorMessage}" class="alert alert-danger">
					        <p th:utext="${errorMessage}"></p>
					    </div>

					    <!-- Hiển thị thông báo thành công -->
					    <div th:if="${successMessage}" class="alert alert-success">
					        <p th:utext="${successMessage}"></p>
					    </div>
					</div>

					<div class="d-flex align-items-center">
						<small class="mb-3 text-danger">1 điểm = 500đ</small>
					</div>
				    <p><strong>Tổng giá trị giỏ hàng:</strong> <span th:text="${cartTotalFormatted}">0</span>đ</p>
				    <p><strong>Dùng điểm:</strong> <span th:text="${discountFromPoints}/500+' điểm '+'= '+${#numbers.formatInteger(discountFromPoints, 0, 'POINT')}"></span>đ</p>
				    <p><strong>Voucher:</strong> <span th:text="${#numbers.formatInteger(voucherDiscount, 0, 'POINT')}"></span> đ</p>
				    <p><strong>Tổng tiền phải thanh toán: <span class="text-danger" style="font-size: 20px;" th:text="${totalPayableFormatted}+'đ'">0</span></p></strong>
				</div>
			</div>

	        <div class="col-md-4 dashed-border-left">
	         
	                <h4>Thông Tin Nhận Hàng</h4>
					<form action="/processCheckout" id="paymentForm" method="post">
					    <hr>
					    <!-- Các thông tin thanh toán khác -->
						<div class="mb-3">
						    <label for="fullname" class="form-label">Người nhận hàng:</label>
						    <input type="text" class="form-control" id="fullname" name="fullname" th:value="${userName}" required>
						</div>
						<div class="mb-3">
						    <label for="phoneNumber" class="form-label">Số điện thoại:</label>
						    <input type="text" class="form-control" id="phoneNumber" name="phoneNumber" th:value="${phoneNumber}" required>
						</div>
						<!-- Ô nhập địa chỉ (Nhấn vào để mở modal) -->
						<div class="mb-3">
						    <label for="address" class="form-label">Địa chỉ giao hàng:</label>
						    <input type="text" class="form-control" id="address" name="address" th:value="${address}" required readonly 
						           data-bs-toggle="modal" data-bs-target="#updateInfoModal" style="cursor: pointer;">
						</div>

						<!-- Nút Lấy vị trí hiện tại -->
						<button type="button" class="btn btn-outline-primary mb-3" onclick="getCurrentLocation()">
						    📍 Lấy vị trí hiện tại
						</button>

						<!-- Modal Cập Nhật Địa Chỉ -->
						<div class="modal fade" id="updateInfoModal" tabindex="-1" aria-labelledby="updateInfoModalLabel" aria-hidden="true">
						    <div class="modal-dialog modal-lg">
						        <div class="modal-content">
						            <div class="modal-header">
						                <h5 class="modal-title">Cập nhật địa chỉ nhận hàng</h5>
						                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
						            </div>

						            <div class="modal-body">
						                <div class="row mb-3">
						                    <div class="col-md-3">
						                        <label for="city" class="form-label">Thành phố:</label>
						                        <select class="form-control" id="city" required>
						                            <option value="">Chọn thành phố</option>
						                            <option value="Hồ Chí Minh">Hồ Chí Minh</option>
						                        </select>
						                    </div>
						                    <div class="col-md-3">
						                        <label for="district" class="form-label">Quận/Huyện:</label>
						                        <select class="form-control" id="district" required>
						                            <option value="">Chọn quận/huyện</option>
						                        </select>
						                    </div>
						                    <div class="col-md-3">
						                        <label for="ward" class="form-label">Phường/Xã:</label>
						                        <select class="form-control" id="ward" required>
						                            <option value="">Chọn phường/xã</option>
						                        </select>
						                    </div>
						                    <div class="col-md-3">
						                        <label for="street" class="form-label">Đường:</label>
						                        <select class="form-control" id="street" required>
						                            <option value="">Chọn đường</option>
						                        </select>
						                    </div>
						                </div>

						                <div class="row mb-3">
						                    <div class="col-md-12">
						                        <label for="houseNumber" class="form-label">Số nhà:</label>
						                        <input type="text" class="form-control" id="houseNumber" placeholder="Nhập số nhà" required>
						                    </div>
						                </div>
						            </div>

						            <div class="modal-footer">
						                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
						                <button type="button" class="btn btn-primary" onclick="updateAddress()">Cập nhật</button>
						            </div>
						        </div>
						    </div>
						</div>

						<script>
						    function getCurrentLocation() {
						        if (navigator.geolocation) {
						            navigator.geolocation.getCurrentPosition(
						                async (position) => {
						                    const lat = position.coords.latitude;
						                    const lng = position.coords.longitude;

						                    // Gọi API Nominatim của OpenStreetMap để lấy địa chỉ từ tọa độ
						                    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;

						                    try {
						                        const response = await fetch(url);
						                        const data = await response.json();
						                        if (data && data.address) {
						                            const address = data.address;

						                            // Điền dữ liệu vào modal
						                            document.getElementById("city").value = "Hồ Chí Minh"; // Cố định TP HCM
						                            document.getElementById("district").value = address.suburb || address.city_district || "";
						                            document.getElementById("ward").value = address.village || address.town || address.city || "";
						                            document.getElementById("street").value = address.road || "";
						                            document.getElementById("houseNumber").value = address.house_number || "";

						                            // Hiển thị địa chỉ trên input chính
						                            document.getElementById("address").value = `${address.house_number || ""}, ${address.road || ""}, ${address.village || address.town || address.city || ""}, ${address.suburb || address.city_district || ""}, Hồ Chí Minh`;

						                            // Hiển thị modal cập nhật địa chỉ
						                            new bootstrap.Modal(document.getElementById("updateInfoModal")).show();
						                        } else {
						                            alert("Không tìm thấy địa chỉ từ tọa độ!");
						                        }
						                    } catch (error) {
						                        console.error("Lỗi khi lấy địa chỉ:", error);
						                        alert("Lỗi khi lấy vị trí, vui lòng thử lại!");
						                    }
						                },
						                (error) => {
						                    let message = "Không thể lấy vị trí, vui lòng bật GPS và thử lại!";
						                    if (error.code === error.PERMISSION_DENIED) {
						                        message = "Bạn đã từ chối quyền truy cập vị trí. Hãy bật GPS và cấp quyền cho trang web!";
						                    } else if (error.code === error.POSITION_UNAVAILABLE) {
						                        message = "Không thể lấy vị trí của bạn, hãy kiểm tra GPS trên thiết bị!";
						                    } else if (error.code === error.TIMEOUT) {
						                        message = "Lấy vị trí quá lâu, vui lòng thử lại!";
						                    }
						                    alert(message);
						                }
						            );
						        } else {
						            alert("Trình duyệt của bạn không hỗ trợ lấy vị trí!");
						        }
						    }
						</script>


						<!-- Script cập nhật địa chỉ -->
						<script>
							const districtsData = {
							    "Hồ Chí Minh": [
							        "Thành phố Thủ Đức", "Quận Bình Thạnh", "Quận Gò Vấp", "Quận 12", "Quận Tân Bình", "Quận Phú Nhuận"
							    ]
							};

							const wardsData = {
							    "Thành phố Thủ Đức": [
							        "Phường Hiệp Bình Chánh", "Phường Hiệp Bình Phước", "Phường Linh Đông", "Phường Linh Tây", "Phường Linh Trung", 
							        "Phường Linh Chiểu", "Phường Trường Thọ", "Phường Bình Thọ", "Phường Tam Phú", "Phường Tam Bình"
							    ],
							    "Quận Bình Thạnh": [
							        "Phường 11", "Phường 12", "Phường 13", "Phường 14", "Phường 15", "Phường 17", "Phường 19", "Phường 21", "Phường 22", "Phường 24"
							    ],
							    "Quận Gò Vấp": [
							        "Phường 1", "Phường 3", "Phường 4", "Phường 5", "Phường 6", "Phường 7", "Phường 8", "Phường 9", "Phường 10", "Phường 11"
							    ],
							    "Quận 12": [
							        "Phường An Phú Đông", "Phường Đông Hưng Thuận", "Phường Hiệp Thành", "Phường Tân Chánh Hiệp", "Phường Tân Hưng Thuận", 
							        "Phường Tân Thới Hiệp", "Phường Tân Thới Nhất", "Phường Thạnh Lộc", "Phường Thạnh Xuân", "Phường Thới An"
							    ]
							};

							const streetsData = {
							    "Thành phố Thủ Đức": {
							        "Phường Hiệp Bình Chánh": [
							            "Phạm Văn Đồng", "Kha Vạn Cân", "Hiệp Bình", "Tam Bình", "Đặng Văn Bi", "Nguyễn Văn Bá", "Võ Văn Ngân", "Tô Ngọc Vân", "Hoàng Diệu 2", "Linh Trung"
							        ],
							        "Phường Hiệp Bình Phước": [
							            "Quốc lộ 13", "Hiệp Bình", "Đường số 23", "Đường số 25", "Đường số 27", "Đường số 29", "Đường số 31", "Đường số 33", "Đường số 35", "Đường số 37"
							        ],
							        "Phường Linh Đông": [
							            "Tô Ngọc Vân", "Phạm Văn Đồng", "Đường số 8", "Đường số 10", "Đường số 20", "Đường số 22", "Đường số 24", "Đường số 26", "Đường số 28", "Đường số 30"
							        ],
							        "Phường Linh Tây": [
							            "Đặng Văn Bi", "Hoàng Diệu 2", "Kha Vạn Cân", "Võ Văn Ngân", "Nguyễn Văn Bá", "Tô Ngọc Vân", "Linh Trung", "Dương Đình Hội", "Đường số 17", "Đường số 19"
							        ],
							        "Phường Linh Trung": [
							            "Lê Văn Chí", "Xa lộ Hà Nội", "Đường số 6", "Đường số 8", "Đường số 10", "Đường số 12", "Đường số 14", "Đường số 16", "Đường số 18", "Đường số 20"
							        ]
							    },
							    "Quận Bình Thạnh": {
							        "Phường 11": [
							            "Điện Biên Phủ", "Nguyễn Hữu Cảnh", "Xô Viết Nghệ Tĩnh", "Bạch Đằng", "Ung Văn Khiêm", "Hoàng Hoa Thám", "Lê Quang Định", "Phan Đăng Lưu", "D2", "D3"
							        ],
							        "Phường 12": [
							            "Bạch Đằng", "Xô Viết Nghệ Tĩnh", "Đinh Bộ Lĩnh", "Chu Văn An", "Lê Trực", "Nguyễn Văn Đậu", "Phan Xích Long", "Hoàng Văn Thụ", "Trần Kế Xương", "Nguyễn Công Hoan"
							        ],
							        "Phường 13": [
							            "Nguyễn Xí", "Đinh Bộ Lĩnh", "Nơ Trang Long", "Phan Văn Trị", "Nguyễn Huy Lượng", "Phan Chu Trinh", "Nguyễn Công Hoan", "Đường D1", "Đường D2", "Đường D3"
							        ]
							    },
							    "Quận Gò Vấp": {
							        "Phường 1": [
							            "Nguyễn Oanh", "Nguyễn Văn Nghi", "Phan Văn Trị", "Lê Quang Định", "Quang Trung", "Dương Quảng Hàm", "Thống Nhất", "Nguyễn Kiệm", "Lê Đức Thọ", "Phạm Văn Chiêu"
							        ],
									"Phường 5": [
							            "Nguyễn Thái Sơn"
							        ],
							        "Phường 12": [
							            "Quang Trung", "Lê Văn Thọ", "Nguyễn Văn Lượng", "Thống Nhất", "Phạm Văn Bạch", "Dương Quảng Hàm", "Nguyễn Tư Giản", "Lý Thường Kiệt", "Trần Thị Nghĩ", "Phan Huy Ích"
							        ]
							    },
							    "Quận 12": {
							        "Phường An Phú Đông": [
							            "Hà Huy Giáp", "Vườn Lài", "Nguyễn Thị Đặng", "Nguyễn Ảnh Thủ", "Đường TX25", "Đường TX21", "Đường TX19", "Đường TX17", "Đường TX15", "Đường TX13"
							        ],
							        "Phường Đông Hưng Thuận": [
							            "Nguyễn Văn Quá", "Tô Ký", "Trường Chinh", "Quang Trung", "Song Hành", "Lê Thị Riêng", "Đường số 2", "Đường số 4", "Đường số 6", "Đường số 8"
							        ],
							        "Phường Tân Chánh Hiệp": [
							            "Tô Ký", "Nguyễn Ảnh Thủ", "Dương Thị Mười", "Song Hành", "Lê Văn Khương", "Đường số 1", "Đường số 3", "Đường số 5", "Đường số 7", "Đường số 9"
							        ]
							    },
							    "Quận Tân Bình": {
							        "Phường 2": [
							            "Trường Sơn", "Cộng Hòa", "Hoàng Văn Thụ", "Phan Đình Giót", "Lý Thường Kiệt", "Đường Ấp Bắc", "Trần Quốc Hoàn", "Hồng Hà", "Nguyễn Sỹ Sách", "Tân Sơn Nhì"
							        ],
							        "Phường 4": [
							            "Hoàng Văn Thụ", "Trần Quốc Hoàn", "Cộng Hòa", "Lê Văn Sỹ", "Nguyễn Thái Bình", "Nguyễn Trọng Tuyển", "Trần Hưng Đạo", "Đồng Đen", "Lạc Long Quân", "Phạm Văn Hai"
							        ]
							    },
							    "Quận Phú Nhuận": {
							        "Phường 9": [
							            "Phan Đăng Lưu", "Phan Xích Long", "Nguyễn Kiệm", "Trần Hữu Trang", "Đào Duy Anh", "Hoàng Văn Thụ", "Nguyễn Đình Chiểu", "Lê Văn Sỹ", "Trường Sa", "Hoàng Sa"
							        ],
							        "Phường 15": [
							            "Nguyễn Văn Trỗi", "Huỳnh Văn Bánh", "Phan Đình Phùng", "Hoàng Văn Thụ", "Nguyễn Kiệm", "Trần Quang Khải", "Trường Sa", "Trần Hưng Đạo", "Lý Chính Thắng", "Phan Xích Long"
							        ]
							    }
							};
							// DOM Elements
							const citySelect = document.getElementById("city");
							const districtSelect = document.getElementById("district");
							const wardSelect = document.getElementById("ward");
							const streetSelect = document.getElementById("street");

							// Hàm cập nhật options cho select
							function updateSelectOptions(selectElement, options, placeholder) {
							    selectElement.innerHTML = `<option value="">${placeholder}</option>`;
							    if (options && options.length) {
							        options.forEach(option => {
							            selectElement.innerHTML += `<option value="${option}">${option}</option>`;
							        });
							        selectElement.disabled = false;
							    } else {
							        selectElement.disabled = true;
							    }
							}

							// Chọn Thành Phố → Hiển thị Quận/Huyện
							citySelect.addEventListener("change", function () {
							    const selectedCity = citySelect.value;
							    resetSelect(districtSelect);
							    resetSelect(wardSelect);
							    resetSelect(streetSelect);
							    
							    if (selectedCity && districtsData[selectedCity]) {
							        updateSelectOptions(districtSelect, districtsData[selectedCity], "Chọn quận/huyện");
							    }
							});

							// Chọn Quận/Huyện → Hiển thị Phường/Xã
							districtSelect.addEventListener("change", function () {
							    const selectedDistrict = districtSelect.value;
							    resetSelect(wardSelect);
							    resetSelect(streetSelect);
							    
							    if (selectedDistrict && wardsData[selectedDistrict]) {
							        updateSelectOptions(wardSelect, wardsData[selectedDistrict], "Chọn phường/xã");
							    }
							});

							// Chọn Phường/Xã → Hiển thị Đường
							wardSelect.addEventListener("change", function () {
							    const selectedDistrict = districtSelect.value;
							    const selectedWard = wardSelect.value;
							    resetSelect(streetSelect);

							    if (selectedDistrict && selectedWard && streetsData[selectedDistrict] && streetsData[selectedDistrict][selectedWard]) {
							        updateSelectOptions(streetSelect, streetsData[selectedDistrict][selectedWard], "Chọn đường");
							    }
							});

							// Reset Select (giữ lại placeholder)
							function resetSelect(selectElement) {
							    selectElement.innerHTML = `<option value="">Chọn</option>`;
							    selectElement.disabled = true;
							}

							function updateAddress() {
							    let city = document.getElementById("city").value;
							    let district = document.getElementById("district").value;
							    let ward = document.getElementById("ward").value;
							    let street = document.getElementById("street").value;
							    let houseNumber = document.getElementById("houseNumber").value;

							    if (!city || !district || !ward || !street || !houseNumber) {
							        alert("Vui lòng điền đầy đủ thông tin!");
							        return;
							    }

							    let fullAddress = `${houseNumber}, ${street}, ${ward}, ${district}, ${city}`;
							    document.getElementById("address").value = fullAddress;

							    // Lấy modal hiện tại và ẩn nó
							    let modalElement = document.getElementById("updateInfoModal");
							    let modalInstance = bootstrap.Modal.getInstance(modalElement);
							    if (modalInstance) {
							        modalInstance.hide();
							    }
							}

						</script>

						<div class="mb-3 ">
						    <label for="deliveryTime" class="col-4 form-label">Giờ giao hàng:</label>
						    <input type="datetime-local" class="form-control" id="deliveryTime" name="deliveryDate" required>
						</div>
						<small id="error-message" style="color: red; display: none;">Vui lòng chọn thời gian hợp lệ!</small>

						<script>
						document.addEventListener("DOMContentLoaded", function () {
						    const deliveryTimeInput = document.getElementById("deliveryTime");
						    const errorMessage = document.getElementById("error-message");

						    function setMinMaxDeliveryTime() {
						        const now = new Date();
						        now.setMinutes(now.getMinutes() + 1); // Không cho phép chọn thời gian trong quá khứ

						        let year = now.getFullYear();
						        let month = String(now.getMonth() + 1).padStart(2, "0");
						        let day = String(now.getDate()).padStart(2, "0");
						        let hours = String(now.getHours()).padStart(2, "0");
						        let minutes = String(now.getMinutes()).padStart(2, "0");

						        // Nếu giờ hiện tại quá trễ (sau 22:00), chuyển sang ngày mai
						        if (now.getHours() >= 22) {
						            now.setDate(now.getDate() + 1);
						        }
						        
						        // Ngày mai
						        const tomorrow = new Date(now);
						        tomorrow.setDate(tomorrow.getDate() + 1);
						        const tomorrowYear = tomorrow.getFullYear();
						        const tomorrowMonth = String(tomorrow.getMonth() + 1).padStart(2, "0");
						        const tomorrowDay = String(tomorrow.getDate()).padStart(2, "0");

						        // Giới hạn ngày được chọn (chỉ hôm nay hoặc ngày mai)
						        const minDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
						        const maxDateTime = `${tomorrowYear}-${tomorrowMonth}-${tomorrowDay}T23:59`;

						        deliveryTimeInput.min = minDateTime; // Giới hạn thời gian tối thiểu
						        deliveryTimeInput.max = maxDateTime; // Giới hạn thời gian tối đa
						        deliveryTimeInput.value = minDateTime; // Đặt giá trị mặc định
						    }

						    setMinMaxDeliveryTime();

						    // Kiểm tra khi người dùng chọn thời gian
						    deliveryTimeInput.addEventListener("input", function () {
						        const selectedDate = new Date(deliveryTimeInput.value);
						        const now = new Date();
						        now.setMinutes(now.getMinutes() + 1);

						        // Tạo ngày hôm nay và ngày mai để so sánh
						        const today = new Date();
						        const tomorrow = new Date();
						        tomorrow.setDate(tomorrow.getDate() + 1);

						        // Chỉ cho phép chọn hôm nay hoặc ngày mai
						        if (selectedDate.toDateString() !== today.toDateString() && selectedDate.toDateString() !== tomorrow.toDateString()) {
						            errorMessage.textContent = "Chỉ có thể chọn ngày hôm nay hoặc ngày mai!";
						            errorMessage.style.display = "block";
						            deliveryTimeInput.value = "";
						            return;
						        }

						        // Nếu chọn ngày hôm nay, giờ phải lớn hơn hiện tại
						        if (selectedDate.toDateString() === today.toDateString() && selectedDate < now) {
						            errorMessage.textContent = "Giờ giao hàng phải sau thời điểm hiện tại!";
						            errorMessage.style.display = "block";
						            deliveryTimeInput.value = "";
						        } else {
						            errorMessage.style.display = "none"; // Ẩn thông báo nếu hợp lệ
						        }
						    });
						});
						</script>

						<div class="mb-3 d-flex">
						    <label for="paymentMethod" class="col-4 form-label">PT thanh toán:</label>
						    <select class="form-select" id="paymentMethod" name="paymentMethod" onchange="confirmVietQR(this)" required>
						        <option value="" selected>Chọn hình thức thanh toán</option> <!-- Mục mặc định -->
						        <option value="momo">MoMo</option>
						        <option value="vietqr">Chuyển khoản VietQR Pro</option>
						        <option value="cod">Thanh toán khi nhận hàng</option>
						    </select>
						</div>
						<div class="mb-3 d-flex">
							<label for="note" class="form-label">Ghi chú:</label>
					        <input type="text" class="form-control" id="note" name="note">
						</div>

						<button type="submit" id="submitBtn" class="btn btn-primary w-100">
						    Thanh toán <i class="fas fa-hand-holding-usd"></i>
						</button>					
					</form>
	            </div>
	        </div>
	    </div>
	</div>

	<script>
		function confirmVietQR(selectElement) {
		    let totalPayable = parseInt(document.getElementById("totalPayable").textContent.replace(/\D/g, ""), 10);

		    // Kiểm tra số tiền phải trên 2000đ
		    if (selectElement.value === "vietqr") {
		        if (totalPayable < 2000) {
		            alert("Để sử dụng VietQR PRO, giá trị đơn hàng phải trên 2.000đ!");
		            selectElement.value = ""; // Reset về mặc định
		            return;
		        }

		        // Hiển thị xác nhận trước khi tạo mã QR
		        let confirmPayment = confirm("Bạn đang chọn thanh toán bằng VietQR. Mã QR sẽ được tạo. Bạn có chắc chắn không?");
		        if (!confirmPayment) {
		            selectElement.value = ""; // Nếu người dùng bấm "Hủy", reset lại lựa chọn
		        }
		    }
		}
	</script>
	<!-- Modal -->
	<div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true">
	    <div class="modal-dialog d-flex justify-content-center align-items-center">
	        <div class="modal-content">
	            <div class="modal-body">
	                <!-- Thanh tiến trình -->
	                <div class="progress">
	                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" id="progressBar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
	                </div>
	                <div class="text-center mt-2">
	                    Đơn hàng đang được gửi đi, vui lòng chờ...
	                </div>
	                <div class="text-center mt-1">
	                    <span id="progressPercent">0%</span>
	                </div>
	            </div>
	        </div>
	    </div>
	</div>

	<!-- Modal Momo QR -->
	<div class="modal fade" id="momoQrModal" tabindex="-1" aria-labelledby="momoQrModalLabel" aria-hidden="true">
	    <div class="modal-dialog modal-dialog-centered modal-lg">
	        <div class="modal-content">
	            <div class="modal-header">
	                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	            </div>
	            <div class="modal-body text-center">
					<h4 class="modal-title">Quét mã QR để thanh toán</h4>

					<img id="momoQrImage"
					     th:src="@{'https://img.vietqr.io/image/VCCB-99MM24740M35863683-qr_only.png?amount=' + ${#numbers.formatInteger(totalPayable, 0)} + '&addInfo=SSW-69319491160&accountName=Huynh%20Thanh%20Phat'}"
					     alt="Mã QR MoMo"
					     class="img-fluid"
					     style="max-width: 50%;">
						 <td colspan="2">
                            <div class="text-success" id="orderValidity">
                                <p class="text-danger">Vui lòng dùng ứng dụng <img src="https://cdn.haitrieu.com/wp-content/uploads/2022/10/Logo-MoMo-Square.png" width="30px" alt=""> để quét mã thanh toán</p>
								<div id="countdownWrapper">
								    Mã QR có hiệu lực trong: <span id="countdown">30</span> giây
								</div>
                            </div>
                            <div class="d-none text-danger" id="Thanhtoanthatbai">Thanh toán thất bại do quá thời gian hiệu lực của mã QR.</div>
							<script>
							    let countdown = 150; // Thời gian đếm ngược
							    const countdownElement = document.getElementById("countdown");
							    const countdownWrapper = document.getElementById("countdownWrapper"); // Thêm dòng này
							    const failedMessage = document.getElementById("Thanhtoanthatbai");

							    function updateCountdown() {
							        if (countdown > 0) {
							            countdown--; // Giảm 1 giây
							            countdownElement.textContent = countdown; // Cập nhật giao diện
							        } else {
							            countdownWrapper.classList.add("d-none"); // Ẩn toàn bộ dòng chứa đồng hồ đếm ngược
							            failedMessage.classList.remove("d-none"); // Hiển thị thông báo thất bại
							            setTimeout(() => {
							                location.reload(); // Reload trang sau 2 giây
							            }, 5000);
							        }
							    }

							    setInterval(updateCountdown, 1000); // Gọi updateCountdown mỗi giây
							</script>


                        </td>
	            </div>
				<p><strong>Tổng tiền phải thanh toán: <span class="text-danger text-align" style="font-size: 20px;" th:text="${totalPayableFormatted}+'đ'">0</span></p></strong>
				<button type="button" class="btn-primary mb-2" width="100%" data-bs-dismiss="modal" aria-label="Close">TÔI ĐÃ THANH TOÁN</button>

			 </div>
	    </div>
	</div>
	<div class="modal fade" id="voucherUsageModal" tabindex="-1" role="dialog" aria-labelledby="voucherUsageModalLabel" aria-hidden="true">
	    <div class="modal-dialog" role="document">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title" id="voucherUsageModalLabel">Điều Kiện Sử Dụng Voucher</h5>
	                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	                    <span aria-hidden="true">&times;</span>
	                </button>
	            </div>
	            <div class="modal-body">
	                <p th:text="${session.voucher != null ? session.voucher.usageCondition : 'Không có thông tin điều kiện'}"></p>
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
	            </div>
	        </div>
	    </div>
	</div>
	
	<script>
	    document.addEventListener("DOMContentLoaded", function () {
	        let errorMessage = document.querySelector(".alert-danger");
	        if (errorMessage && errorMessage.innerHTML.includes("Xem điều kiện sử dụng")) {
	            new bootstrap.Modal(document.getElementById("voucherUsageModal")).show();
	        }
	    });
	</script>

	<!-- Modal Viet QR -->
	<div class="modal fade" id="vietQrModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" aria-labelledby="vietQrModalLabel" aria-hidden="true">
		<div class="modal-overlay"></div> <!-- Lớp phủ -->
	    <div class="modal-dialog modal-dialog-centered" style="max-width: 500px;">
	        <div class="modal-content" style="border-radius: 15px; background-color: #1D2453; color: white; text-align: center; padding: 20px;">
				<div class="modal-header border-0 d-flex flex-column">
				    <h4 class="modal-title" style="color: #FFC107;">
				        Mã QR thanh toán tự động
				    </h4>
				    <p class="text-light" style="font-size: 12px;">
				        (Xác nhận tự động - Thường không quá 3s)
				    </p>
				</div>
	            <span id="orderCode" th:text="${orderCode}" hidden></span>
	            <span id="totalPayable" th:text="${#numbers.formatInteger(totalPayable, 0)}" hidden></span>

	            <div class="modal-body">
					<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="" height="" viewBox="0 0 1370 68" fill="none" hidden>
					CHỮ VIETQR
					<g xmlns="http://www.w3.org/2000/svg" clip-path="url(#clip0_8273_43719)">
					        <path d="M42.6695 29.9766C43.2281 29.9769 43.7637 30.2003 44.1585 30.5975C44.5533 30.9947 44.7751 31.5333 44.7751 32.0948V48.1522C44.7751 48.7136 44.5533 49.252 44.1584 49.649C43.7635 50.046 43.228 50.269 42.6695 50.269C42.1109 50.269 41.5752 50.0461 41.1801 49.6491C40.785 49.2522 40.5629 48.7137 40.5625 48.1522V32.0948C40.5629 31.5331 40.785 30.9946 41.18 30.5974C41.5751 30.2002 42.1108 29.9769 42.6695 29.9766Z" fill="#ED1B2F"/>
					        <path d="M51.546 46.4424H60.2226C60.72 46.4424 61.1969 46.6411 61.5486 46.9946C61.9003 47.3482 62.0978 47.8277 62.0978 48.3277V48.3852C62.0978 48.6327 62.0493 48.8778 61.9551 49.1065C61.8608 49.3351 61.7227 49.5428 61.5485 49.7178C61.3744 49.8927 61.1676 50.0315 60.9401 50.126C60.7126 50.2206 60.4688 50.2692 60.2226 50.269H47.7188V29.9766H60.0704C60.3166 29.9766 60.5604 30.0253 60.7878 30.1201C61.0153 30.2149 61.2219 30.3537 61.3959 30.5288C61.5699 30.7039 61.7079 30.9117 61.802 31.1404C61.8961 31.3692 61.9444 31.6143 61.9443 31.8618V31.9193C61.9443 32.1667 61.8958 32.4117 61.8016 32.6402C61.7074 32.8688 61.5694 33.0765 61.3954 33.2514C61.2214 33.4263 61.0148 33.5651 60.7875 33.6598C60.5602 33.7544 60.3165 33.8032 60.0704 33.8032H51.546V38.1225H59.6934C59.9396 38.1225 60.1834 38.1712 60.4108 38.266C60.6383 38.3608 60.8449 38.4996 61.0189 38.6747C61.1929 38.8498 61.3309 39.0576 61.425 39.2864C61.5191 39.5151 61.5674 39.7602 61.5673 40.0077C61.5673 40.2551 61.5188 40.5 61.4246 40.7286C61.3304 40.9572 61.1924 41.1648 61.0184 41.3398C60.8444 41.5147 60.6378 41.6534 60.4105 41.7481C60.1832 41.8428 59.9395 41.8915 59.6934 41.8915H51.546V46.4424Z" fill="#ED1B2F"/>
					        <path d="M77.6508 31.8899C77.6508 32.1415 77.6014 32.3906 77.5055 32.623C77.4096 32.8554 77.2691 33.0665 77.0919 33.2443C76.9147 33.422 76.7044 33.5628 76.473 33.6587C76.2417 33.7546 75.9937 33.8037 75.7435 33.8032H72.2667V48.3557C72.2667 48.8632 72.0662 49.3498 71.7093 49.7087C71.3523 50.0675 70.8683 50.269 70.3635 50.269H69.9558C69.451 50.269 68.967 50.0675 68.6101 49.7087C68.2531 49.3498 68.0526 48.8632 68.0526 48.3557V33.8032H64.6024C64.0976 33.8032 63.6136 33.6016 63.2566 33.2428C62.8997 32.884 62.6992 32.3973 62.6992 31.8899C62.6992 31.3824 62.8997 30.8958 63.2566 30.537C63.6136 30.1781 64.0976 29.9766 64.6024 29.9766H75.7435C75.9937 29.9762 76.2415 30.0254 76.4728 30.1214C76.7041 30.2173 76.9144 30.3582 77.0915 30.5359C77.2686 30.7136 77.4092 30.9246 77.5052 31.1569C77.6011 31.3892 77.6506 31.6383 77.6508 31.8899Z" fill="#ED1B2F"/>
					        <path d="M116.752 43.9971C118.247 43.2675 119.452 42.0498 120.169 40.5428C120.886 39.0359 121.073 37.329 120.7 35.7011C120.328 34.0733 119.416 32.6207 118.116 31.5808C116.815 30.541 115.203 29.9754 113.541 29.9766L103.383 30.0004V50.4389H107.798V33.7821H113.541C114.395 33.7811 115.222 34.0889 115.869 34.6494C116.517 35.2098 116.942 35.9856 117.068 36.8352C117.194 37.6848 117.012 38.5516 116.555 39.2775C116.098 40.0034 115.397 40.5401 114.58 40.7896L113.602 39.3423H108.953L116.472 50.4319H121.124L116.752 43.9971Z" fill="#1E4382"/>
					        <path d="M90.6291 29.6243C87.8623 29.5557 85.181 30.5909 83.1711 32.5037C81.1613 34.4166 79.9864 37.0515 79.9032 39.8326C79.82 42.6137 80.8352 45.3149 82.7271 47.3457C84.6189 49.3766 87.2335 50.5719 89.9993 50.6706C90.2074 50.6832 90.4182 50.6916 90.6291 50.6916H93.8182L91.1345 46.7317H90.6291C89.1687 46.733 87.7497 46.2445 86.5966 45.3437C85.4435 44.4429 84.6221 43.1811 84.2627 41.7582C83.9032 40.3352 84.0261 38.8324 84.6119 37.4876C85.1977 36.1428 86.2129 35.0328 87.4969 34.3334C88.7808 33.6339 90.2602 33.385 91.7007 33.626C93.1412 33.8671 94.4606 34.5842 95.4501 35.664C96.4395 36.7438 97.0424 38.1245 97.1634 39.5876C97.2843 41.0507 96.9165 42.5125 96.1179 43.7417L93.9858 40.5959H90.185L93.7931 45.9203L96.5228 49.9603L96.8468 50.439H100.648L98.4428 47.1683C99.7913 45.6525 100.674 43.7767 100.985 41.7673C101.296 39.7579 101.021 37.701 100.194 35.8452C99.3672 33.9894 98.0233 32.4141 96.3249 31.3096C94.6265 30.2051 92.6462 29.6188 90.6235 29.6215L90.6291 29.6243Z" fill="#1E4382"/>
					        <path d="M19.8836 50.4879C19.7062 50.4792 19.5275 50.462 19.3516 50.4375C19.5289 50.462 19.7062 50.4792 19.8836 50.4879Z" stroke="#231F20" stroke-width="0.3"/>
					        <path d="M20.9987 50.4375H20.9727H20.9987Z" stroke="#231F20" stroke-width="0.3"/>
					        <path d="M20.4433 50.4883C20.3498 50.4883 20.2576 50.4883 20.1641 50.4883C20.2576 50.4897 20.3512 50.4926 20.4433 50.4883Z" stroke="#231F20" stroke-width="0.3"/>
					        <path d="M19.3489 50.4375H19.3242H19.3489Z" stroke="#231F20" stroke-width="0.3"/>
					        <path d="M20.1621 50.4922C20.0685 50.4922 19.9764 50.4922 19.8828 50.4922C19.9764 50.4951 20.0685 50.4922 20.1621 50.4922Z" stroke="#231F20" stroke-width="0.3"/>
					        <path d="M20.9734 50.4375C20.7975 50.462 20.6201 50.4792 20.4414 50.4879C20.6187 50.4792 20.7961 50.462 20.9734 50.4375Z" stroke="#231F20" stroke-width="0.3"/>
					        <path d="M36.5002 17.6068C35.1142 16.7502 33.4465 16.482 31.8639 16.8613C30.2813 17.2407 28.9134 18.2364 28.061 19.6296L21.0404 31.1052L20.4525 32.0611C20.3464 32.2015 20.2375 32.3419 20.1188 32.4724C19.482 33.1884 18.6877 33.7448 17.7991 34.0973C16.9105 34.4499 15.9523 34.5888 15.0008 34.5031C14.0493 34.4173 13.131 34.1092 12.3189 33.6033C11.5069 33.0975 10.8237 32.4079 10.3238 31.5895L6.14745 24.7687C5.68503 24.0109 5.39158 23.1613 5.28733 22.2785C5.25527 22.0083 5.24081 21.7364 5.24404 21.4643C5.28322 20.6832 5.5595 19.933 6.0357 19.3146C6.5119 18.6962 7.16515 18.2393 7.90749 18.0054C8.64982 17.7716 9.4456 17.7721 10.1877 18.0067C10.9297 18.2414 11.5825 18.699 12.058 19.318C11.1638 17.9524 9.76672 16.9999 8.17398 16.6699C6.58124 16.3399 4.92333 16.6595 3.565 17.5584C2.20666 18.4573 1.25915 19.8619 0.930912 21.4631C0.602675 23.0643 0.920596 24.7311 1.81474 26.0967L14.7556 47.2454C15.2112 48.1035 15.8631 48.8403 16.6578 49.3951C17.4524 49.9499 18.3669 50.3067 19.3257 50.4361H19.3522C19.5282 50.46 19.7069 50.4768 19.8842 50.4852C19.9778 50.4852 20.0699 50.4852 20.1635 50.4852C20.257 50.4852 20.3492 50.4852 20.4427 50.4852C20.6215 50.4768 20.7988 50.46 20.9747 50.4361H21.0027C21.9614 50.3062 22.8757 49.9492 23.6702 49.3945C24.4648 48.8398 25.1169 48.1032 25.5727 47.2454L38.5122 26.0967C38.9354 25.4066 39.2191 24.6394 39.347 23.8391C39.4749 23.0387 39.4445 22.2208 39.2576 21.4322C39.0707 20.6437 38.731 19.8999 38.2578 19.2435C37.7847 18.5871 37.1874 18.0309 36.5002 17.6068Z" fill="#ED1B2F"/>
					        <path d="M14.9552 24.0264L12.2646 19.6299C12.2003 19.5232 12.1249 19.4249 12.0565 19.3239C11.5813 18.7052 10.9291 18.2476 10.1875 18.0128C9.44591 17.7779 8.65058 17.777 7.90846 18.0101C7.16634 18.2433 6.51304 18.6993 6.03644 19.3169C5.55984 19.9345 5.28279 20.684 5.24257 21.4646C5.23958 21.7348 5.25404 22.0048 5.28586 22.2731C5.39011 23.156 5.68356 24.0056 6.14598 24.7634L10.3265 31.5841C10.8264 32.4025 11.5096 33.0921 12.3217 33.598C13.1337 34.1038 14.0521 34.4119 15.0035 34.4977C15.955 34.5835 16.9132 34.4445 17.8018 34.092C18.6904 33.7394 19.4848 33.183 20.1215 32.4671L14.9552 24.0264Z" fill="#A01E21"/>
					    </g>
					</svg>
					
	                <img id="vietQrImage"
	                     th:src="@{'https://img.vietqr.io/image/BIDV-V3CASSSUSHIWA-qr_only.png?amount=' + ${#numbers.formatInteger(totalPayable, 0)} + '&addInfo=' + ${orderCode} +'user:' +${session.loggedInUser} + '&accountName=Huynh%20Thanh%20Phat'}"
	                     alt="Mã QR VietQR"
	                     class="img-fluid"
	                     style="max-width: 60%; border: 2px solid white; border-radius: 10px;">

	                <p  class="mt-3" style="font-size: 18px;">
	                    <strong>Số tiền:</strong>
	                    <span class="text-warning" style="font-size: 22px;" th:text="${totalPayableFormatted}+'đ'">0</span>
	                </p>
					<p class="text-start" style="font-size: 16px;">
					    <strong>Nội dung (bắt buộc):</strong> 
						<span class="text-info" th:text="${#strings.replace(orderCode, '-', '')}">MÃ ĐƠN HÀNG</span>
					</p>

					<p class="text-start" style="font-size: 16px;">
					    <strong>Người thụ hưởng: HUYNH THANH PHAT</strong>
					</p>
					<hr> 
	                <div class="progress mt-4" style="height: 8px;" hidden>
	                    <div id="paymentProgress" class="progress-bar bg-warning" role="progressbar" style="width: 0%;"></div>
	                </div>
					<img src="https://mpos.vn/assets/landingV2/Landing-mPos-V2/mpos-assets/img/group-visa.svg" width="100%">
										
					<p class="text-light" style="font-size: 13px;">
						Nhận tiền từ mọi Ngân hàng và Ví điện tử
					</p>
					
	                <p class="mt-2" id="paymentTimer" style="font-size: 14px;">Đang chờ thanh toán 5:00</p>
					<div class="line-loading"></div>
					
					<button id="saveFullModal" class="btn btn-success mt-3">
					    <i class="fas fa-download"></i> Lưu ảnh
					</button>

	                <button id="changePaymentMethod" class="btn btn-outline-primary mt-3"><i class="fas fa-sync-alt"></i>Đổi phương thức thanh toán</button>
	            </div>
	        </div>
	    </div>
	</div>

	<!-- Modal Thanh toán thành công -->
	<div class="modal fade" id="paymentSuccessModal" tabindex="-1" aria-hidden="true">
	    <div class="modal-dialog modal-dialog-centered">
	        <div class="modal-content" style="border-radius: 15px; background-color: #1D2453; color: white; text-align: center; padding: 20px;">
	            <div class="modal-body">
	                <h4 class="text-success">✅ Thanh toán thành công</h4>
	                <div class="progress mt-3" style="height: 8px;">
	                    <div id="redirectProgress" class="progress-bar bg-info" role="progressbar" style="width: 0%;"></div>
	                </div>
	                <p class="mt-2" id="redirectTimer">Bắt đầu sau 5s</p>
	            </div>
	        </div>
	    </div>
	</div>

	<script>
		document.addEventListener("DOMContentLoaded", function () {
		    let timeLeft = 300; // 5 phút đếm ngược
		    let progressBar = document.getElementById("paymentProgress");
		    let timerText = document.getElementById("paymentTimer");
		    let orderCode = document.getElementById("orderCode").innerText.trim();
		    const totalPayable = parseInt(document.getElementById("totalPayable").innerText.trim(), 10);
		    const changePaymentBtn = document.getElementById("changePaymentMethod");
		    let paymentInterval;
		    let isPaymentSuccessful = false; // Biến kiểm soát trạng thái thanh toán
			let redirectCountdownStarted = false;
			let successModalShown = false;
			
			let paymentForm = document.getElementById("paymentForm"); // Lấy form thanh toán
			
			 let submitBtn = document.getElementById("submitBtn"); // Nút submit

			 // Vô hiệu hóa nút submit khi chọn VietQR
			 function checkSubmitStatus() {
			     let paymentMethod = document.getElementById("paymentMethod").value;
			     if (paymentMethod === "vietqr" && !isPaymentSuccessful) {
			         submitBtn.disabled = true;
			     } else {
			         submitBtn.disabled = false;
			     }
			 }
			 document.getElementById("paymentMethod").addEventListener("change", checkSubmitStatus);


		    // Loại bỏ dấu '-' trong orderCode
		    orderCode = orderCode.replace(/-/g, "");
		    console.log("Order Code (đã loại bỏ '-'): ", orderCode);
		    console.log("Total Payable:", totalPayable);

		    function startCountdown() {
		        let interval = setInterval(() => {
		            if (timeLeft <= 0) {
		                clearInterval(interval);
						clearInterval(paymentInterval);
						clearTimeout(); // Xóa mọi timeout

						$('#vietQrModal').modal('hide'); 
						$('#vietQrModal').removeClass('show');
						$('body').removeClass('modal-open');
						$('.modal-backdrop').remove();
		                $('#vietQrModal').modal('hide');
		                $('#paymentSuccessModal').modal('show');
		                startRedirectCountdown();
		            } else {
		                let minutes = Math.floor(timeLeft / 60);
		                let seconds = timeLeft % 60;
		                progressBar.style.width = ((300 - timeLeft) / 300 * 100) + "%";
		                timerText.innerText = `Đang chờ thanh toán ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
		                timeLeft--;
		            }
		        }, 1000);
		    }

		    function startRedirectCountdown() {
				if (redirectCountdownStarted) return;
				redirectCountdownStarted = true;
		        let redirectTime = 5;
		        let redirectBar = document.getElementById("redirectProgress");
		        let redirectText = document.getElementById("redirectTimer");
		        let interval = setInterval(() => {
		            if (redirectTime <= 0) {
		                clearInterval(interval);
						clearInterval(paymentInterval);
						clearTimeout(); // Xóa mọi timeout

						$('#vietQrModal').modal('hide'); 
						$('#vietQrModal').removeClass('show');
						$('body').removeClass('modal-open');
						$('.modal-backdrop').remove();
						$('#vietQrModal').modal('hide');
						$('#paymentSuccessModal').modal('hide');
		            } else {
		                redirectBar.style.width = ((5 - redirectTime) * 20) + "%";
		                redirectText.innerText = `Bắt đầu sau ${redirectTime}s`;
		                redirectTime--;
		            }
		        }, 1000);
		    }

		    async function checkPayment() {
		        if (isPaymentSuccessful) {
		            console.log("✅ Đã xác nhận thanh toán thành công, dừng kiểm tra!");
		            return;
		        }

		        try {
		            const response = await fetch('https://script.google.com/macros/s/AKfycbxttABThmHWbgwFya4GEc4QX97ZkIUTHg40OePnNPYOuwbciKw20vaDcp6bfA69Zw-O/exec');
		            const data = await response.json();

		            if (data.error || !data.data) {
		                console.warn("⚠ Không tìm thấy dữ liệu giao dịch.");
		                return;
		            }

		            const transactions = data.data;
		            const paymentFound = transactions.some(tx =>
		                tx["Mô tả"].includes(orderCode) && tx["Giá trị"] === totalPayable
		            );

		            if (paymentFound) {
		                console.log("✅ Thanh toán thành công!");

						isPaymentSuccessful = true; // Đánh dấu trạng thái thanh toán thành công
						clearInterval(paymentInterval); // Dừng kiểm tra
						clearTimeout(); // Xóa mọi timeout

						$('#vietQrModal').modal('hide'); 
						$('#vietQrModal').removeClass('show');
						$('body').removeClass('modal-open');
						$('.modal-backdrop').remove();
					
		                // Đảm bảo modal VietQR đã ẩn rồi mới hiện modal thành công
						if (!successModalShown) {
	                   successModalShown = true;
	                   setTimeout(() => {
	                       $('#paymentSuccessModal').modal('show');
	                       startRedirectCountdown();
	                   }, 500);}
		            } else {
		                console.log("⏳ Chưa nhận được thanh toán, tiếp tục kiểm tra...");
		            }
		        } catch (error) {
		            console.error("❌ Lỗi khi kiểm tra thanh toán:", error);
		        }
				// Khi modal thanh toán thành công bị ẩn -> Submit form
				   $('#paymentSuccessModal').on('hidden.bs.modal', function () {
				       console.log("📌 Modal thanh toán thành công đã ẩn, tiến hành submit form...");

				       if (paymentForm) {
				           paymentForm.submit();
						   // Chờ 3 giây rồi chuyển hướng đến /processCheckout
					         setTimeout(function () {
					             window.location.href = "/checkoutSuccess";
					         }, 1500);
				       } else {
				           console.error("⚠ Không tìm thấy form thanh toán!");
				       }
				   });
		    }

		    $('#vietQrModal').on('shown.bs.modal', function () {
		        startCountdown();
		        paymentInterval = setInterval(checkPayment, 1000); // Kiểm tra mỗi 5 giây
		    });

		    changePaymentBtn.addEventListener("click", function () {
		        if (confirm("Bạn có chắc chắn muốn đổi phương thức thanh toán không?")) {
		            clearInterval(paymentInterval);
		            $('#vietQrModal').modal('hide');
		            location.reload(); // Load lại trang sau khi đổi phương thức thanh toán
		        }
		    });

		    // Đảm bảo modal VietQR được đóng đúng cách
		    $('#vietQrModal').on('hidden.bs.modal', function () {
		        clearInterval(paymentInterval);
		    });
		});
		document.addEventListener("DOMContentLoaded", function () {
		    let saveButton = document.getElementById("saveFullModal");
		    let modal = document.getElementById("vietQrModal");

		    saveButton.addEventListener("click", function () {
		        html2canvas(modal, { scale: 2 }).then(canvas => {
		            let link = document.createElement("a");
		            link.href = canvas.toDataURL("image/png");
		            link.download = "VietQR_Payment.png";
		            document.body.appendChild(link);
		            link.click();
		            document.body.removeChild(link);
		        });
		    });
		});

	</script>


	<script>
		document.addEventListener("DOMContentLoaded", function () {
		    var vietQrModal = document.getElementById("vietQrModal");

		    // Khi modal mở, thêm lớp phủ
		    vietQrModal.addEventListener("shown.bs.modal", function () {
		        document.querySelector(".modal-overlay").style.display = "block";
		    });

		    // Ngăn modal bị đóng khi bấm vào lớp phủ
		    document.querySelector(".modal-overlay").addEventListener("click", function (event) {
		        event.stopPropagation(); // Ngăn sự kiện bấm ra ngoài đóng modal
		    });
		});

	</script>


	<script>
	document.getElementById("paymentMethod").addEventListener("change", function () {
	    if (this.value === "momo") {
	        // Mở modal khi phương thức thanh toán là MoMo
	        new bootstrap.Modal(document.getElementById("momoQrModal")).show();
	    }
	});
	document.getElementById("paymentMethod").addEventListener("change", function () {
		    if (this.value === "vietqr") {
		        // Mở modal khi phương thức thanh toán là MoMo
		        new bootstrap.Modal(document.getElementById("vietQrModal")).show();
		    }
		});
	</script>
	<div id="imageModal" class="modal" style="display: none;">
		    <span class="close" onclick="closeModal()">&times;</span>
		        <img class="modal-content2" id="modalImage">
		    <div class="controls">
		        <button onclick="zoomOut()">-</button>
		        <button onclick="zoomIn()">+</button>
		    </div>
		</div>
	<footer class="footer mt-4">
	       <div class="container">
	           <div class="row">
	               <div class="col-md-4">
	                   <h5 class="footer-logo">Sushi Wa</h5>
	                   <p>Sushi và Lẩu Băng chuyền tại Tầng B1 GigaMall Tp.Thủ Đức</p>
	               </div>
	               <div class="col-md-4">
	                   <h5>Bạn cần hỗ trợ</h5>
	                   <p>
	                       <strong>Hoteline: 097 480 2998</strong><br>
	                       Địa chỉ: Tầng B1, TTTM GigaMall, 240-242 Phạm Văn Đồng, Hiệp Bình Chánh, Thủ Đức, Tp. Hồ Chí Minh<br>
	                       Email: <a href="mailto:hotro.sushiwa@gmail.com">hotro.sushiwa@gmail.com</a>
	                   </p>
					   <div class="social-icons">
					       <a href="https://www.facebook.com/sushiwa" target="_blank" aria-label="Facebook">
					           <i class="fab fa-facebook-f"></i>
					       </a>
					       <a href="https://www.twitter.com" target="_blank" aria-label="Twitter">
					           <i class="fab fa-twitter"></i>
					       </a>
					       <a href="https://www.youtube.com" target="_blank" aria-label="YouTube">
					           <i class="fab fa-youtube"></i>
					       </a>
					       <a href="https://www.instagram.com" target="_blank" aria-label="Instagram">
					           <i class="fab fa-instagram"></i>
					       </a>
					   </div>
					   <div class="payment-icons mt-3">
					       <a href="https://visa.com" target="_blank" aria-label="Stripe">
					           <img src="https://cdn-icons-png.flaticon.com/512/196/196578.png" alt="Visa">
					       </a>
					       <a href="https://www.mastercard.com" target="_blank" aria-label="mastercard">
					           <img src="https://cdn-icons-png.flaticon.com/512/196/196561.png" alt="Mastercard">
					       </a>
					       <a href="https://www.stripe.com" target="_blank" aria-label="Visa">
					           <img src="https://cdn-icons-png.flaticon.com/512/825/825425.png" alt="Stripe">
					       </a>
					       <a href="https://www.paypal.com" target="_blank" aria-label="MasterCard">
					           <img src="https://cdn-icons-png.flaticon.com/512/196/196565.png" alt="Paypal">
					       </a>
					   </div>
	               </div>
	               <div class="col-md-2">
	                   <h5>Hướng dẫn</h5>
	                   <ul class="list-unstyled">
	                       <li><a href="#">Cách đặt món</a></li>
	                       <li><a href="#">Phương thức thanh toán</a></li>
	                       <li><a href="#">Giao hàng tận nơi</a></li>
	                       <li><a href="#">Chính sách đổi trả</a></li>
	                       <li><a href="#">Câu hỏi thường gặp</a></li>
	                   </ul>
	               </div>
	               <div class="col-md-2">
	                   <h5>Hỗ trợ khách hàng</h5>
	                   <ul class="list-unstyled">
	                       <li><a href="#">Liên hệ chúng tôi</a></li>
	                       <li><a href="#">Tư vấn thực đơn</a></li>
	                       <li><a href="#">Hướng dẫn đặt tiệc</a></li>
	                       <li><a href="#">Chính sách bảo mật</a></li>
	                       <li><a href="#">Điều khoản sử dụng</a></li>
	                   </ul>
	               </div>
	           </div>
	       </div>
	</footer>

	<script>
		// Cập nhật thanh tiến trình trong khoảng thời gian này
		function updateProgressBarBasedOnTime() {
		    var progressBar = document.getElementById('progressBar');
		    var progressPercent = document.getElementById('progressPercent');
		    var totalTime = 5000; // Tổng thời gian gửi email (5000ms)
		    var intervalTime = 6; // Cập nhật mỗi 50ms
		    var width = 0;
		    var totalUpdates = totalTime / intervalTime;

		    var interval = setInterval(function () {
		        if (width >= 100) {
		            clearInterval(interval);
		        } else {
		            width += 100 / totalUpdates;
		            progressBar.style.width = width + '%';
		            progressPercent.textContent = Math.floor(width) + '%';
		        }
		    }, intervalTime);
		}

		// Kiểm tra xem tất cả các trường đã được điền đầy đủ chưa
		function validateForm() {
		    var isValid = true;
		    var fields = [
		        { id: 'fullname', name: 'Người nhận hàng' },
		        { id: 'phoneNumber', name: 'Số điện thoại' },
		        { id: 'address', name: 'Địa chỉ giao hàng' },
		        { id: 'deliveryTime', name: 'Giờ giao hàng' },
		        { id: 'paymentMethod', name: 'Phương thức thanh toán' }
		    ];
		    var errorMessage = "";

		    fields.forEach(field => {
		        var input = document.getElementById(field.id);
		        if (!input.value.trim()) {
		            input.style.border = "2px solid red";
		            errorMessage += `- ${field.name} chưa được chọn!\n`;
		            isValid = false;
		        } else {
		            input.style.border = "";
		        }
		    });

		    if (!isValid) {
		        alert("Vui lòng nhập đầy đủ thông tin trước khi thanh toán:\n" + errorMessage);
		    }
		    return isValid;
		}

		// Xử lý khi nhấn nút thanh toán
		const thanhToanButton = document.querySelector('button.btn.btn-primary.w-100');
		thanhToanButton.addEventListener("click", function (event) {
		    event.preventDefault();

		    if (!validateForm()) {
		        return;
		    }

		    var myModal = new bootstrap.Modal(document.getElementById('loadingModal'));
		    myModal.show();
		    updateProgressBarBasedOnTime();

		    setTimeout(function () {
		        // Gửi form trước
		        thanhToanButton.closest("form").submit();

		        // Chuyển hướng sau 2 giây
		        setTimeout(function () {
		            window.location.href = "/checkoutSuccess";
		        }, 2000);
		    }, 0.1); // Giả lập việc gửi email trong 1 giây (có thể điều chỉnh)
		});
		function openModal(imgElement) {
			       var modal = document.getElementById("imageModal");
			       var modalImg = document.getElementById("modalImage");

			       // Chỉ hiển thị modal khi người dùng nhấp vào ảnh
			       if (imgElement && imgElement.src) {
			           modal.classList.add("show");
			           modal.style.display = "flex"; 
			           modalImg.src = imgElement.src;
			           modalImg.style.transform = "scale(1)"; // Reset scale
			       }
			   }

			   function closeModal() {
			       var modal = document.getElementById("imageModal");
			       modal.classList.remove("show");
			       modal.style.display = "none"; 
			   }


			   function zoomIn() {
			       var img = document.getElementById("modalImage");
			       var scale = getCurrentScale(img) + 0.2;
			       img.style.transform = `scale(${scale})`;
			   }

			   function zoomOut() {
			       var img = document.getElementById("modalImage");
			       var scale = getCurrentScale(img) - 0.2;
			       if (scale > 0.5) { // Giới hạn thu nhỏ
			           img.style.transform = `scale(${scale})`;
			       }
			   }

			   function getCurrentScale(img) {
			       var transform = window.getComputedStyle(img).transform;
			       if (transform !== "none") {
			           var matrix = transform.match(/matrix\((.+)\)/);
			           if (matrix) {
			               return parseFloat(matrix[1].split(", ")[0]);
			           }
			       }
			       return 1;
			   }
	</script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

	<!-- Bootstrap JS (cần thiết cho modal và các thành phần Bootstrap khác) -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
		<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.7/dist/umd/popper.min.js"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
